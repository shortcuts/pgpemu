name: main

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize]

concurrency:
  group: github.head_ref
  cancel-in-progress: true

jobs:
  # lint:
  #   runs-on: ubuntu-latest
  #   steps:
  #   - uses: actions/checkout@v4
  #
  #   - uses: jidicula/clang-format-action@v4.15.0
  #     with:
  #       clang-format-version: '20'
  #       check-path: 'pgpemu-esp32'

  build:
    # needs:
    #   - lint
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: setup secrets.csv
      run: mv pgpemu-esp32/secrets.example.csv pgpemu-esp32/secrets.csv

    - name: esp-idf build
      uses: espressif/esp-idf-ci-action@v1
      with:
        esp_idf_version: v5.4.1
        target: esp32c3
        path: 'pgpemu-esp32'

  release:
    if: ${{ github.ref == 'refs/heads/main' }}
    needs:
      - build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/release-please-action@v4
        id: release
        with:
          release-type: simple
          package-name: pgpemu

      - name: tag stable versions
        if: ${{ steps.release.outputs.release_created }}
        run: |
          git config user.name github-actions[bot]
          git config user.email github-actions[bot]@users.noreply.github.com
          git remote add gh-token "https://${{ secrets.GITHUB_TOKEN }}@github.com/google-github-actions/release-please-action.git"
          git tag -d stable || true
          git push origin :stable || true
          git tag -a stable -m "Last Stable Release"
          git push origin stable
